{% extends 'base.html' %}
{% load static %}

{% block title %}Rēķini - {{ company.name }} - Propmty{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        {% include "partials/sidebar.html" %}
        
        <!-- Galvenais saturs -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                <h1 class="h2">Rēķini</h1>
                
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle me-2" data-bs-toggle="dropdown">
                        <i class="bi bi-funnel"></i> Filtri
                    </button>
                    <div class="dropdown-menu p-3" style="width: 300px;">
                        <form method="get">
                            <div class="mb-3">
                                <label class="form-label">Statuss</label>
                                <select name="status" class="form-select">
                                    <option value="">Visi</option>
                                    <option value="draft" {% if filters.status == 'draft' %}selected{% endif %}>Melnraksts</option>
                                    <option value="sent" {% if filters.status == 'sent' %}selected{% endif %}>Nosūtīts</option>
                                    <option value="paid" {% if filters.status == 'paid' %}selected{% endif %}>Apmaksāts</option>
                                    <option value="overdue" {% if filters.status == 'overdue' %}selected{% endif %}>Kavēts</option>
                                    <option value="cancelled" {% if filters.status == 'cancelled' %}selected{% endif %}>Atcelts</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Līgums</label>
                                <select name="lease" class="form-select">
                                    <option value="">Visi</option>
                                    {% for lease in active_leases %}
                                    <option value="{{ lease.id }}" {% if filters.lease_id == lease.id|stringformat:"s" %}selected{% endif %}>
                                        {{ lease.unit.property.address }} - {{ lease.unit.unit_number }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Datums no</label>
                                <input type="date" name="date_from" class="form-control" value="{{ filters.date_from|default:'' }}">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Datums līdz</label>
                                <input type="date" name="date_to" class="form-control" value="{{ filters.date_to|default:'' }}">
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">Filtrēt</button>
                                <a href="{% url 'invoices:invoice_list' company.slug %}" class="btn btn-outline-secondary">Notīrīt</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Rēķinu saraksts -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    {% if invoices %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Numurs</th>
                                    <th>Īpašums/Telpa</th>
                                    <th>Īrnieks</th>
                                    <th>Summa</th>
                                    <th>Datums</th>
                                    <th>Apmaksas termiņš</th>
                                    <th>Statuss</th>
                                    <th>Darbības</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for invoice in invoices %}
                                <tr>
                                    <td>{{ invoice.number }}</td>
                                    <td>
                                        {{ invoice.lease.unit.property.address|capfirst }} - {{ invoice.lease.unit.unit_number }}
                                    </td>
                                    <td>
                                        {% if invoice.lease.tenant %}
                                            {{ invoice.lease.tenant.get_full_name }}
                                        {% else %}
                                            <span class="badge bg-warning">Nav īrnieka</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ invoice.total_amount }} €</td>
                                    <td>{{ invoice.issue_date|date:"d.m.Y" }}</td>
                                    <td>{{ invoice.due_date|date:"d.m.Y" }}</td>
                                    <td>
                                        {% if invoice.status == 'draft' %}
                                            <span class="badge bg-secondary">Melnraksts</span>
                                        {% elif invoice.status == 'sent' %}
                                            <span class="badge bg-primary">Nosūtīts</span>
                                        {% elif invoice.status == 'paid' %}
                                            <span class="badge bg-success">Apmaksāts</span>
                                        {% elif invoice.status == 'overdue' %}
                                            <span class="badge bg-danger">Kavēts</span>
                                        {% elif invoice.status == 'cancelled' %}
                                            <span class="badge bg-warning">Atcelts</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'invoices:invoice_detail' company.slug invoice.id %}" class="btn btn-outline-primary" title="Skatīt">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            {% if invoice.status == 'draft' %}
                                            <a href="{% url 'invoices:invoice_edit' company.slug invoice.id %}" class="btn btn-outline-secondary" title="Rediģēt">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-receipt fs-1 text-muted"></i>
                        </div>
                        <h4>Nav atrasti rēķini</h4>
                        <p class="text-muted">Izmantojot filtrus, mēģiniet izmainīt meklēšanas kritērijus vai izveidojiet jaunu rēķinu.</p>
                    </div>
                    {% endif %}
                    
                    <!-- Jauna rēķina izveides sadaļa -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Izveidot jaunu rēķinu</h5>
                        </div>
                        <div class="card-body">
                            {% if active_leases %}
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <input type="text" id="leaseSearch" class="form-control" placeholder="Meklēt pēc adreses, dzīvokļa vai īrnieka...">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <select id="leaseSort" class="form-select">
                                                <option value="address">Kārtot pēc adreses</option>
                                                <option value="tenant">Kārtot pēc īrnieka</option>
                                                <option value="unit">Kārtot pēc dzīvokļa/telpas</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover" id="leaseTable">
                                        <thead>
                                            <tr>
                                                <th>Adrese</th>
                                                <th>Telpa/Dzīvoklis</th>
                                                <th>Īrnieks</th>
                                                <th>Īres maksa</th>
                                                <th>Darbības</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for lease in active_leases %}
                                            <tr class="lease-row" 
                                                data-address="{{ lease.unit.property.address|lower }}" 
                                                data-unit="{{ lease.unit.unit_number|lower }}" 
                                                data-tenant="{% if lease.tenant %}{{ lease.tenant.get_full_name|lower }}{% endif %}">
                                                <td>{{ lease.unit.property.address|capfirst }}</td>
                                                <td>{{ lease.unit.unit_number }}</td>
                                                <td>
                                                    {% if lease.tenant %}
                                                        {{ lease.tenant.get_full_name }}
                                                    {% else %}
                                                        <span class="badge bg-warning">Nav īrnieka</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ lease.rent_amount }} €/mēn.</td>
                                                <td>
                                                    {% if lease.tenant %}
                                                    <a href="{% url 'invoices:invoice_create' company.slug lease.id %}" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-plus-circle"></i> Izveidot rēķinu
                                                    </a>
                                                    {% else %}
                                                    <button class="btn btn-sm btn-secondary" disabled>
                                                        <i class="bi bi-plus-circle"></i> Izveidot rēķinu
                                                    </button>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Ja daudz līgumu, rādam lapošanu -->
                                {% if active_leases.count > 10 %}
                                <div class="mt-3">
                                    <nav aria-label="Līgumu lapošana">
                                        <ul class="pagination justify-content-center" id="leasePagination">
                                            <!-- Lapošanas pogas tiks ģenerētas ar JavaScript -->
                                        </ul>
                                    </nav>
                                </div>
                                {% endif %}
                                
                                <script>
                                    document.addEventListener('DOMContentLoaded', function() {
                                        const searchInput = document.getElementById('leaseSearch');
                                        const sortSelect = document.getElementById('leaseSort');
                                        const leaseTable = document.getElementById('leaseTable');
                                        const leaseRows = Array.from(document.querySelectorAll('.lease-row'));
                                        const rowsPerPage = 10;
                                        let currentPage = 1;
                                        let filteredRows = [...leaseRows];
                                        
                                        // Meklēšanas funkcija
                                        function filterRows() {
                                            const searchTerm = searchInput.value.toLowerCase();
                                            filteredRows = leaseRows.filter(row => {
                                                const address = row.getAttribute('data-address');
                                                const unit = row.getAttribute('data-unit');
                                                const tenant = row.getAttribute('data-tenant');
                                                
                                                return address.includes(searchTerm) || 
                                                    unit.includes(searchTerm) || 
                                                    (tenant && tenant.includes(searchTerm));
                                            });
                                            
                                            // Kārtojam rindas
                                            sortRows();
                                            
                                            // Atjaunojam lapošanu un rādam pirmo lapu
                                            currentPage = 1;
                                            updatePagination();
                                            showPage(currentPage);
                                        }
                                        
                                        // Kārtošanas funkcija
                                        function sortRows() {
                                            const sortBy = sortSelect.value;
                                            
                                            filteredRows.sort((a, b) => {
                                                if (sortBy === 'address') {
                                                    return a.getAttribute('data-address').localeCompare(b.getAttribute('data-address'));
                                                } else if (sortBy === 'tenant') {
                                                    const tenantA = a.getAttribute('data-tenant') || '';
                                                    const tenantB = b.getAttribute('data-tenant') || '';
                                                    return tenantA.localeCompare(tenantB);
                                                } else { // unit
                                                    return a.getAttribute('data-unit').localeCompare(b.getAttribute('data-unit'));
                                                }
                                            });
                                        }
                                        
                                        // Lapošanas atjaunināšana
                                        function updatePagination() {
                                            const paginationElement = document.getElementById('leasePagination');
                                            if (!paginationElement) return;
                                            
                                            const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
                                            paginationElement.innerHTML = '';
                                            
                                            // Iepriekšējā lapa
                                            const prevItem = document.createElement('li');
                                            prevItem.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
                                            prevItem.innerHTML = '<a class="page-link" href="#">Iepriekšējā</a>';
                                            prevItem.addEventListener('click', (e) => {
                                                e.preventDefault();
                                                if (currentPage > 1) {
                                                    currentPage--;
                                                    showPage(currentPage);
                                                    updatePagination();
                                                }
                                            });
                                            paginationElement.appendChild(prevItem);
                                            
                                            // Lapu numuri
                                            for (let i = 1; i <= totalPages; i++) {
                                                const pageItem = document.createElement('li');
                                                pageItem.className = 'page-item' + (i === currentPage ? ' active' : '');
                                                pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                                                pageItem.addEventListener('click', (e) => {
                                                    e.preventDefault();
                                                    currentPage = i;
                                                    showPage(currentPage);
                                                    updatePagination();
                                                });
                                                paginationElement.appendChild(pageItem);
                                            }
                                            
                                            // Nākamā lapa
                                            const nextItem = document.createElement('li');
                                            nextItem.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
                                            nextItem.innerHTML = '<a class="page-link" href="#">Nākamā</a>';
                                            nextItem.addEventListener('click', (e) => {
                                                e.preventDefault();
                                                if (currentPage < totalPages) {
                                                    currentPage++;
                                                    showPage(currentPage);
                                                    updatePagination();
                                                }
                                            });
                                            paginationElement.appendChild(nextItem);
                                        }
                                        
                                        // Rādīt konkrētu lapu
                                        function showPage(page) {
                                            const startIndex = (page - 1) * rowsPerPage;
                                            const endIndex = startIndex + rowsPerPage;
                                            
                                            // Slēpjam visas rindas
                                            leaseRows.forEach(row => {
                                                row.style.display = 'none';
                                            });
                                            
                                            // Rādam tikai filtrētās rindas no konkrētās lapas
                                            filteredRows.slice(startIndex, endIndex).forEach(row => {
                                                row.style.display = '';
                                            });
                                        }
                                        
                                        // Pievienojam notikumu klausītājus
                                        searchInput.addEventListener('input', filterRows);
                                        sortSelect.addEventListener('change', () => {
                                            sortRows();
                                            showPage(currentPage);
                                            updatePagination();
                                        });
                                        
                                        // Inicializējam skatu
                                        sortRows();
                                        updatePagination();
                                        showPage(currentPage);
                                    });
                                </script>
                            {% else %}
                                <div class="alert alert-info">
                                    Nav aktīvu īres līgumu. Vispirms izveidojiet īres līgumu ar īrnieku.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}